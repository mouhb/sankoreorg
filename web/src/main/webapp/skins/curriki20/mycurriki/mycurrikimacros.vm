## vim: ts=4:sw=4
#**
  *
  * My Curriki Macros
  *
  * The my curriki module is the personal pages of each user
  *
  * The following sections are available in MySankore:
  *
  * - Profile
  * - Favorites
  * - Contributions
  * - Groups
  * - Blog (see blog/blogmacros.vm)
  *
  * These macros are used in the pages of the Wiki MySankore space
  *
  *#

##
## My Curriki General Macros
##
##

#macro(mycurriki_jsx)
<script type="text/javascript" src="$xwiki.getSkinFile('mycurriki/mycurriki.js', true)"></script>
#end


#**
  * Adding a dash instead of an empty text
  *
  * @param $text Text to test
  * @author dward@curriki.org
  *#
#macro(mycurriki_dashifempty $text)
  #if($!text == "")
    $msg.get("profile.emptyField")
  #else
    $text
  #end
#end


#**
  * Display the my curriki tabs for the top of the page
  *
  * @param $curtab Current active tab
  * @param $whofor Name of the user to evaluate the links
  * @author dward@curriki.org
  *#
#macro(mycurriki_tabs $curtab $whofor)
  #set($tabs = ["profile","favorites","contributions","collections","groups"])
  <ul id="mycurriki-tabs" class="tabs">
  #foreach($tab in $tabs)
    #if("$!whofor" == "" || $whofor == $context.user)
      #set($url=$xwiki.getURL($msg.get("mycurriki.tab.${tab}.page"), "view"))
    #else
      #set($url=$xwiki.getURL($msg.get("mycurriki.tab.${tab}.page"), "view", "user=${whofor}"))
    #end
    <li#if($curtab==$tab) class="current"#end><a href="$url">$msg.get("mycurriki.tab.${tab}.label")</a></li>
  #end
  </ul>
#end

#**
  * Display the MySankore header
  *
  * @param $userobj User object to display the form for
  * @author dward@curriki.org
  *#
#macro(mycurriki_header $userobj)
  <h2>$userobj.first_name $userobj.last_name</h2>
#end


#**
  * My Curriki Main Page Header
  * This macro is called by every my curriki page
  *
  * @param $pageref Page Name to use in call back
  * @param $whofor User to display the page for
  * @author dward@curriki.org
  *#
#macro(mycurriki_pageheader $pageref $whofor)
  ## Bounce guest to login page if trying to view "own" profile
  #if(("$!request.user"=="") && ($context.user=="XWiki.XWikiGuest"))
    #set($logredir = $doc.getURL("view"))
    #set($loginurl = $xwiki.getURL("XWiki.XWikiLogin", "login", "xredirect=$logredir"))
    $response.sendRedirect($loginurl)
  #end
  $xwiki.ssfx.use("curriki.css")
  $xwiki.ssfx.use("mycurriki.css")
  ## Determine whofor
  #if("$!whofor" == "")
    #if("$!request.user" != "")
      #set($whofor = $request.user)
    #else
      #if($doc.web.startsWith("Blog_"))
        #set($whofor = $doc.web.substring(5))
      #else
        #if("$!whofor" == "")
          #set($whofor = $context.user)
        #end
      #end
    #end
  #end
  #if(!$whofor.startsWith("XWiki."))
    #set($whofor = "XWiki.$whofor")
  #end
  ## Now know whofor
  #set($userdoc = $xwiki.getDocument($whofor))
  #set($userobj = $userdoc.getObject("XWiki.XWikiUsers"))
  #set($g_userdoc = $userdoc)
  #set($g_userobj = $userobj)
  <div id="mycurriki-$pageref" class="mycurriki mycurriki-$pageref">
  #sankore_profilelinks($userdoc $userobj)
  #mycurriki_tabs($pageref $whofor)
  <div id="mycurriki-main" class="tab-container">
  <div id="mycurriki-main-header">
#end

#**
  * My Curriki Sankore Profile Links
  * This macro is called by every my curriki page
  *
  * 
  * @param $userdoc User document
  * @param $userobj User object
  * @author flavius.olaru@xwiki.com
  *#
#macro(sankore_profilelinks $userdoc $userobj)
#if("$context.user" == "$userdoc.fullName")
<div class="profile-links">    
  <h2>$msg.get('profile.welcome', ["$userdoc.display('first_name', 'view', $userobj) $userdoc.display('last_name', 'view', $userobj)"])</h2></th>
  <ul>
    #set($url = $xwiki.getURL("MySankore.EditProfile", "view", "user=${context.user}"))
    <li class="profile-link"><a href="$url">$msg.get("sankore.profile.editprofile.title")</a></li>
    #set($url = $xwiki.getURL("Search.Groups", "view"))
    <li class="profile-link"><a href="$!url">$msg.get("sankore.profile.downloadplugin.title")</a></li>  
    #set($url = $xwiki.getURL("Invitation.WebHome", "view"))
    <li class="profile-link"><a href="$!url">$msg.get("sankore.profile.joingroup.title")</a></li>
    #set($url = $xwiki.getURL("LaCommunaute.BookmarkletSetup", "view"))
    <li class="profile-link"><a href="$url">$msg.get("sankore.profile.inviteuser.title")</a></li>
  </ul>  
</div>
#end
#end

#**
  * My Curriki Main Page Content Header
  * This macro is called by every my curriki page
  *
  * @param $pageref Page Name to use in call back
  * @param $whofor User to display the page for
  * @author dward@curriki.org
  *#
#macro(mycurriki_pagecontentheader $pageref $whofor)
#if("$!pageref" == "blog")
  #set($hasBlog=$xwiki.exists("Blog_${shortname}.WebHome"))
  #if(!$hasBlog)
    #set($subtitle = $msg.get("mycurriki.tab.${pageref}.noblog.subtitle", ["$userobj.first_name $userobj.last_name"]))
  #else
    #set($subtitle = $msg.get("mycurriki.tab.${pageref}.subtitle", ["$userobj.first_name $userobj.last_name"]))
  #end
#else
  #set($subtitle = $msg.get("mycurriki.tab.${pageref}.subtitle"))
#end
<div id="mycurriki-main-header-left">
#if($subtitle != "" && $subtitle != "mycurriki.tab.${pageref}.subtitle")
  <div id="mycurriki-main-header-subtitle" class="tab-deck">$subtitle</div>
#end
</div>
<div class="clearfloats"></div>
#*
the footer (#footerglobal)  is being injected in the wrong container on this page: http://sankore.devxwiki.com/xwiki/bin/view/MySankore/Profile as opposed to the normal behaviour on other pages such as http://sankore.devxwiki.com/xwiki/bin/view/Main/JoinSankore for example.
The footer is good looking: inside #xwikimaincontainerinner
The footer is bad looking: inside #contentcontainer
Solution: Commenting the div element
*#
##<div id="mycurriki-main-content">
#end
##
#**
  * My Curriki Main Page Footer
  * This macro is called by every my curriki page
  *
  * @param $pageref Page Name to use in call back
  * @param $whofor User to display the page for
  * @author dward@curriki.org
  *#
#macro(mycurriki_pagefooter)
</div>
</div>
</div>
#end
##

## OBSOLETE
#**
  * My Curriki Main Page Generation
  * This macro is called by every my curriki page and uses callbacks defined as macro in the wiki page
  *
  * @param $pageref Page Name to use in call back
  * @param $whofor User to display the page for
  * $param $hasbutton True if the page uses buttons
  * @author dward@curriki.org
  *#
#macro(mycurriki_pagefull $pageref $whofor $hasbutton) ## {
## Determine whofor
#if("$!whofor" == "") ## {
#if("$!request.user" != "") ## {
#set($whofor = $request.user)
#else ## } {
#if($doc.web.startsWith("Blog_")) ## {
#set($whofor = $doc.web.substring(5))
#else ## } {
#if("$!whofor" == "") ## {
#set($whofor = $context.user)
#end ## }
#end ## }
#end ## }
#end ## }
#if(!$whofor.startsWith("XWiki.")) ## {
#set($whofor = "XWiki.$whofor")
#end ## }
## Now know whofor
#set($userdoc = $xwiki.getDocument($whofor))
#set($userobj = $userdoc.getObject("XWiki.XWikiUsers"))
#set($g_userdoc = $userdoc)
#set($g_userobj = $userobj)
<div id="mycurriki-$pageref" class="mycurriki mycurriki-$pageref">
#mycurriki_header($userobj)
#mycurriki_tabs($pageref $whofor)
<div id="mycurriki-main" class="tab-container">
<div id="mycurriki-main-header">
#if($hasbutton == 1) ## {
## This is a call back to the local macro of the page including this macro
#mycurriki_pagebutton($userobj)
#end ## }
#if("$!pageref" == "blog") ## {
#set($hasBlog=$xwiki.exists("Blog_${shortname}.WebHome"))
#if(!$hasBlog) ## {
#set($subtitle = $msg.get("mycurriki.tab.${pageref}.noblog.subtitle", ["$userobj.first_name $userobj.last_name"]))
#else ## }{
#set($subtitle = $msg.get("mycurriki.tab.${pageref}.subtitle", ["$userobj.first_name $userobj.last_name"]))
#end ## }
#else ## } {
#set($subtitle = $msg.get("mycurriki.tab.${pageref}.subtitle"))
#end ## }
<div id="mycurriki-main-header-left">
#if($subtitle != "" && $subtitle != "mycurriki.tab.${pageref}.subtitle") ## {
<div id="mycurriki-main-header-subtitle" class="tab-deck">$subtitle</div>
#end ## }
</div>
<div class="clearfloats"></div>
</div>
<div id="mycurriki-main-content" class="frame pad-btm">
## This is a call back to the local macro of the page including this macro
#mycurriki_pagecontent($userdoc $userobj)
</div>
</div>
</div>
#end ##macro ## }
##


## OBSOLETE
#**
  * My Curriki callback function
  *
  * @param $pageref Page Name to use in call back
  * @author dward@curriki.org
  *#
#macro(mycurriki_page $pageref)
  ## This is a call back to the local macro of the page including this macro
  #mycurriki_pagefull($pageref "" 0)
#end

## OBSOLETE
#**
  * My Curriki callback function with a button
  *
  * @param $pageref Page Name to use in call back
  * @author dward@curriki.org
  *#
#macro(mycurriki_pagewithbutton $pageref) ## {
## This is a call back to the local macro of the page including this macro
#mycurriki_pagefull($pageref "" 1)
#end ##macro ## }

#**
  * Display the title of an Asset
  *
  * @param $asset Asset to display the title for
  * @author dward@curriki.org
  *#
#macro(mycurriki_assettitle $asset) ## {
#asset_findtitle($asset)
#set($title = $currikiTitle)
#if(!$title || $title.length() == 0) ## {
 #set($title = $msg.get("caption.untitled"))
#end ## }
<a class="curriki-link" href="$asset.getURL("view")">verbatim($title)</a>
#end ## macro ## }

#**
  * Display the title of an Asset with a mouserover description
  *
  * @param $asset Asset to display the title for
  * @author dward@curriki.org
  *#
#macro(mycurriki_assettitlewithmodesc $asset) ## {
#if("$!descnb" == "") ##{
#set($descnb=0)
#end ##}
#set($descnb = $descnb + 1)
#asset_findtitle($asset)
#set($title = $currikiTitle)
#if(!$title || $title.length() == 0) ## {
 #set($title = $msg.get("caption.untitled"))
#end ## }
<a id="mycurriki-title-${descnb}" class="curriki-link" href="$asset.getURL("view")">$title</a>
<script type="text/javascript">
/* <![CDATA[ */
#if("$!descpopupjs" == "") ##{
#set($descpopupjs=1)
Ext.ns('Curriki.mycurriki.util.title');
Curriki.mycurriki.util.title.popup = function(title_id, attr){
  if ('string' === Ext.type(attr.description)
      && 'array' === Ext.type(attr.fwItems)
      && 'array' === Ext.type(attr.levels)
      && 'array' === Ext.type(attr.ict)
  ) {
    var desc = attr.description||'';
    desc = Ext.util.Format.ellipsis(desc, 256);
    desc = Ext.util.Format.htmlEncode(desc);

    var fw = Curriki.data.fw_item.getRolloverDisplay(attr.fwItems||[]);
    var lvl = Curriki.data.el.getRolloverDisplay(attr.levels||[]);
    var ict = Curriki.data.ict.getRolloverDisplay(attr.ict||[]);
    
    var qtip = String.format("{1}<br />{0}<br /><br />{3}<br />{2}<br />{5}<br />{4}<br />{7}<br />{6}"
      ,desc,_('global.title.popup.description')
      ,fw,_('global.title.popup.subject')
      ,lvl,_('global.title.popup.educationlevel')
      ,ict,_('global.title.popup.ict')
    );

    Ext.QuickTips.getQuickTip().register({
      target:title_id
      ,text:qtip
    });
  }
};
#end ##}
Ext.onReady(function(){
  Curriki.data.EventManager.on('Curriki.data:ready', function(){
## Get description
#set($curDesc = $!asset.getDescription().replaceAll('\\', '\\\\').replace("'", "\'").replaceAll("[\r\n]", ' '))
## Get Framework items
#set($curFW = "")
#set($subj = $!asset.getValue('fw_items'))
#set($isFirst = true)
#foreach($item in $subj) ## {
#if($item != "FW_masterFramework.WebHome") ## {
#if($isFirst) ##{
#set($isFirst = false)
#else ##}{
#set($curFW = "$curFW, ")
#end ## }
#set($curFW = "$curFW'$item'")
#end ## }
#end ## }
#set($curFW = "[ $curFW ]")
## Get educational levels
#set($curLvl = "")
#set($levl = $!asset.getValue('educational_level'))
#set($isFirst = true)
#foreach($item in $levl) ## {
#if($isFirst) ##{
#set($isFirst = false)
#else ##}{
#set($curLvl = "$curLvl, ")
#end ## }
#set($curLvl = "$curLvl'$item'")
#end ## }
#set($curLvl = "[ $curLvl ]")
## Get icts
#set($curICT = "")
#set($ict = $!asset.getValue('instructional_component'))
#set($isFirst = true)
#foreach($item in $ict) ## {
#if($isFirst) ##{
#set($isFirst = false)
#else ##}{
#set($curICT = "$curICT, ")
#end ## }
#set($curICT = "$curICT'$item'")
#end ## }
#set($curICT = "[ $curICT ]")
Curriki.mycurriki.util.title.popup("mycurriki-title-${descnb}", {'description':'$curDesc' , 'fwItems':$curFW , 'levels':$curLvl , 'ict':$curICT});
});
});
/* ]]> */
</script>
#end ## macro ## }

#**
  * Display Rights status of an Asset
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_access $asset) ## {
#set($access = $!asset.getObject("CurrikiCode.AssetClass").getProperty("rights").getValue())
$msg.get("mycurriki.macro.access.${access}")
#end ## macro ## }


#**
  * Display the ict of an Asset
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_ict $asset)
#set($ict = $!asset.getObject("CurrikiCode.AssetClass").getProperty("instructional_component").getValue())
#if($ict == "" || $ict.size() == 0) 
  #set($text = "")
#else
  #set($text = $asset.display("instructional_component"))
#end ## if not empty
<span>${text}</span>
#end ## Macro


#**
  * Display the file type of an Asset
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_filetype $asset)
$xwiki.ssfx.use("curriki/filetypes.css")
#if("$!ftnb" == "")
  #set($ftnb = 0)
#end
#set($ftnb = $ftnb + 1)
#set($assetType = $!asset.getAssetType())
#set($category = $!asset.getCategory())
#if("$!category" == "")
  #set($category = "unknown")
#end
#set($subcategory = $!asset.getCategorySubtype())
#if("$!subcategory" == "")
  #set($subcategory = "unknown")
#end
#set($rollover = $msg.get("${category}.${subcategory}"))
#if($!rollover == "${category}.${subcategory}")
  #set($rollover = $msg.get('search.resource.icon.Unknown.rollover'))
#end
#verbatim_start
<img id="favorites-filetype-${ftnb}" class="resource-${assetType} category-${category} subcategory-${category}_${subcategory}" src="/xwiki/skins/curriki8/extjs/resources/images/default/s.gif" ext:qtip="${rollover}"/>
#verbatim_end
#end ## Macro

#**
  * Display the last update date of an Asset
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_lastupdate $asset) ## {
$!xwiki.formatDate($asset.contentUpdateDate, $msg.get("mycurriki.dateFormat"))
#end ## macro ## }

#**
  * Display the contributor of an Asset
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_contributor $asset) ## {
$xwiki.getUserName($asset.creator)
#end ## macro ## }


#**
  * Display the description of a collection
  *
  * @param $asset Asset
  * @author dward@curriki.org
  *#
#macro(mycurriki_collectiondescription $asset) ## {
#set($desc = $!asset.getObject("CurrikiCode.AssetClass").getProperty("description").getValue())
$!desc
#end ## macro ## }

##
## My Curriki Profile
##
##
#**
  * Display the user photo with a link to remove it
  *
  * @param $userdoc Name of the user to evaluate the links
  * @param $xeditredirect Redirect link after remove
  * @author dward@curriki.org
  *#
#macro(mycurriki_editphoto $userdoc $xeditredirect)
<div class="userpic">
#set($width = 200)
#if($userdoc.attachmentList.size() == 0)
  <img src="$xwiki.getSkinFile("noavatar.png")" width="${width}"/>
#else
  #foreach($attach in $userdoc.attachmentList)
  <a class="curriki-link" href="$userdoc.getAttachmentURL($attach.filename,"download")" >
    <img src="$userdoc.getAttachmentURL($attach.filename,"download")" width="${width}" /></a>
    #set($removeURL = $userdoc.getAttachmentURL("${attach.filename}", "delattachment", "xredirect=${xeditredirect}"))
      <a class="curriki-link" id="profile-removephoto" href="${removeURL}" onclick="return confirm('$msg.get("profile.removePhoto.confirmation")');" title="$msg.get("profile.removeYourPhoto")">$msg.get("profile.removePhoto")</a>
  #end
#end
</div>
#end

#**
  * Display profile in edit mode
  *
  * @param $userdoc User document to display the form for
  * @param $userobj User object to display the form for
  * @author dward@curriki.org
  *#
#macro(mycurriki_editprofile $userdoc $userobj)
<fieldset class="userInfo">
<h2>$msg.get("profile.section.userInfo")</h2>
<ul>
<li id="first_name">  
  <span class="label"><strong>$msg.get("profile.field.display.firstName")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("first_name", "edit", $userobj))</span>
</li>
<li id="last_name">
  <span class="label"><strong>$msg.get("profile.field.display.lastName")</strong></span>
  <span class="value">#mycurriki_dashifempty($userdoc.display("last_name", "edit", $userobj))</span>
</li>
<li id="city">  
  <span class="label"><strong>$msg.get("profile.field.city")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("city", "edit", $userobj))</span>
</li>
##<li id="state">
  ##<span class="label"><strong>$msg.get("profile.field.state")</strong></span>    
  ##<span class="value">#mycurriki_dashifempty($userdoc.display("state", "edit", $userobj))</span>
##</li>
<li id="country">
  <span class="label"><strong>$msg.get("profile.field.country")</strong></span>    
  <span id="value">
    <select id="XWiki.XWikiUsers_0_country" size="1" name="XWiki.XWikiUsers_0_country">
    #set($xwikiusers_xclass = $xwiki.getClass("XWiki.XWikiUsers"))
    #set($field_xclass = $xwikiusers_xclass.get('country'))
    #set($hashmap = $util.hashMap)
    #set($keys = $field_xclass.listValues)
    #set($values = $util.arrayList)
    #foreach($key in $keys)
      #set($value = $msg.get("XWiki.XWikiUsers_country_${key}"))
      #set($discard = $values.add($value))
      #set($discard = $hashmap.put($value, $key))
    #end
    #set($sorted = $sorttool.sort($values))
    #set($currentCountry = $userobj.getProperty('country').value)
    #foreach($value in $sorted)
      #set($currentKey = $hashmap.get($value))
      <option label="$value" value="$currentKey" #if($currentCountry == $currentKey) selected="selected" #end >$value</option>
    #end
    </select>
  ##mycurriki_dashifempty($userdoc.display("country", "edit", $userobj))
  </span>
</li>
<li id="email">
  <span class="label"><strong>$msg.get("profile.field.email")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("email", "edit", $userobj))</span>
</li>
<li id="member_type">  
  <span class="label"><strong>$msg.get("profile.field.memberType")</strong></span>
  <span class="value">#mycurriki_dashifempty($userdoc.display("member_type", "edit", $userobj))</span>
</li>
<li id="affiliation">
  <span class="label"><strong>$msg.get("profile.field.affiliation")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("affiliation", "edit", $userobj))</span>
</li>      
  #if($context.user == $userdoc.fullName || $hasGlobalAdmin)
<li id="password">        
  <span class="label"><strong>$msg.get("profile.field.password")</strong></span>
  <span class="value"><input size='30' id='password' name='password' type='password'/></span>
</li>
<li id="password_repead">    
  <span class="label"><strong>$msg.get("profile.field.passwordConfirm")</strong></span>
  <span class="value"><input size='30' id='password_repeat' name='password_repeat' type='password'/></span>
</li>    
  #end
<li id="bio">  
  <span class="label"><strong>$msg.get("profile.field.bio")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("comment", "edit", $userobj))</span>
</li>
</ul>
</fieldset>
<fieldset class="userPrivacy">
<h2>$msg.get("profile.section.userPrivacy")</h2>
<ul>
<li id="show_contact">  
  <span class="value">#mycurriki_dashifempty($userdoc.display("show_contact", "edit", $userobj))</span>
  <span class="label"><strong>$msg.get("profile.field.showContact")</strong></span>
</li>
<li id="opt_out">  
  <span class="value">#mycurriki_dashifempty($userdoc.display("opt_out", "edit", $userobj))</span>
  <span class="label"><strong>$msg.get("profile.field.opt_out")</strong></span>    
</li>
</ul>
</fieldset>
#end


#**
  * Display profile edit buttons
  *
  * @param $xredirect redirect url to send to
  * @author dward@curriki.org
  *#
#macro(mycurriki_editprofilebuttons $xredirect)
<fieldset class="buttons">
  <input class="button button-cancel mgn-rt" type="submit" name="formactioncancel" value="$msg.get("cancel")" onclick="document.forms.inline.action='$userdoc.getURL("cancel", "xredirect=$xredirect")'; document.forms.inline.submit(); return false;"/>
  <input class="button button-confirm" type="submit" name="formactionsave" value="$msg.get("mycurriki.editprofile.saveButton")" onclick="document.forms.inline.action='$userdoc.getURL("save", "xredirect=$xredirect")'; if(document.forms.inline.onsubmit() == false) return false; document.forms.inline.submit(); return false;"/>
</fieldset>
#end

#**
  * Display profile editing box
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  * @author dward@curriki.org
  *#
#macro(mycurriki_editprofilebox $userdoc $userobj)
#if($context.user == $userdoc.fullName)
  #set($userarg = "")
#else ## user == owner
  #set($userarg = "user=${userdoc.fullName}")
  #if(!$xwiki.hasAdminRights())
    $response.sendRedirect($xwiki.getURL('MySankore.Profile', "$userarg"))
  #end ## not admin
#end ## user == owner
#set($xredirect = $xwiki.getURL("MySankore.Profile", "view", "$userarg"))
#set($xeditredirect = $xwiki.getURL("MySankore.Profile", "edit", "$userarg"))
#set($xredirectemail = $xwiki.getURL("MySankore.EditProfileEmail", "view", "$userarg"))
#set($xredirectemail2 = $xwiki.getURL("Registration.EmailVerification", "view", "username=${userdoc.name}"))
##curriki_titlebar($msg.get("mycurriki.editprofile.titlebar") "" "" "blue")
<div class="edit-profile">
#mycurriki_jsx()
<form id="inline" action="$userdoc.getURL("preview")" method="post" onsubmit="return Curriki.mycurriki.validateInlineForm();">
  <input id="origemail" name="origemail" type="hidden" value="${userobj.getProperty('email').getValue()}" />
  <input id="origpassword" name="origpassword" type="hidden" value="${userobj.getProperty('password').getValue()}" />
  <table border="0" cellspacing="0" cellpadding="3">
  <tbody>
  <tr>
    <td valign="top">
      #mycurriki_editphoto($userdoc $xeditredirect)
    </td>
    <td width="100%">
      #mycurriki_editprofile($userdoc $userobj)
    </td>
  </tr>
  </tbody>
  </table>
  #mycurriki_editprofilebuttons($xredirect)
</form>
</div>
#if("$!footerJScript" == "")
  #set($footerJScript = "")
#end
#set($footerJScript = $footerJScript + '<script>$$("a").invoke("observe", "click", function(event){ var el = Event.element(event); if (((typeof el.id == "undefined") || (el.id != "profile-removephoto")) && !confirm("'+$msg.get('mycurriki.editprofile.confirmLeave')+'")){event=event||window.event; if (typeof event.preventDefault != "undefined") { event.preventDefault(); } else if (window.event){ event.returnValue = false; } }; });</script>')
#end

#**
  * Displays the edit profile button for the user
  *
  * @param $userdoc Document of the user
  *#
#macro(mycurriki_editprofilebutton $userdoc)
  #if($context.action == "view" && ($context.user==$userdoc.fullName || $xwiki.hasAdminRights()))
    <a class="button button-confirm" href="$xwiki.getURL("MySankore.EditProfile", "view", "user=${userdoc.fullName}")" title="$msg.get("mycurriki.profile.editButton")">$msg.get("mycurriki.profile.editButton")</a></span>
  #end
#end


#**
  * Displays the photo of the user
  *
  * @param $userdoc Document of the user
  *#
#macro(mycurriki_viewphoto $userdoc)
<div class="userpic">
#if($userdoc.attachmentList.size()==0)
  <img src="$xwiki.getSkinFile("noavatar.png")"/>
  #if($context.action=="view" && ($userdoc.fullName == $context.user || $hasGlobalAdmin))
  <a class="curriki-link" onclick='document.getElementById("attachdiv").attributes["class"].value="visible"; $("mycurriki-main-content").scrollTo(); return false;'>$msg.get('profile.changeMyPhoto')</a>
  #end
#else ## attachmentList.size must be > 0
  #foreach ($attach in $userdoc.attachmentList)
    <a class="curriki-link" href="$userdoc.getAttachmentURL($attach.filename,"download")" >
      <img src="$userdoc.getAttachmentURL($attach.filename,"download")"  />
    </a>
    #if ($context.action=="inline")
      #set($deleteredir = $userdoc.getURL("inline"))
      <a class="curriki-link" href="$userdoc.getAttachmentURL("${attach.filename}", "delattachment", "xredirect=${deleteredir}")" onclick="return confirm(&quot;$msg.get("profile.removePhoto.confirmation")&quot;);" title="$msg.get("profile.removeYourPhoto")">$msg.get("profile.removePhoto")</a>
  #end ## if inline
  #end ## foreach attach in list
  #if ($context.action!="inline")
    #set($i = $context.user.indexOf(":")+1)
    #set($attach = $userdoc.attachmentList.get(0))
    #if ($context.user.substring($i) == $userdoc.fullName || $hasGlobalAdmin)
    #set($deleteredir = $doc.getURL("view"))
    <a class="curriki-link" href="$userdoc.getAttachmentURL("${attach.filename}", "delattachment", "xredirect=${deleteredir}")" onclick="return confirm(&quot;$msg.get("profile.modifyPhoto.confirmation")&quot;);" >$msg.get("profile.modifyYourPhoto")</a>
  #end ## is same user
      #end ## is inline
   #end ##
</div>
#end

#**
  * Edit the profile email
  *
  *#
#macro(mycurriki_editprofileemail)
## A user changed their email address
## Force them to validate first
#if($isGuest)
  ## Not a real user -- Just bounce to home
  ## TODO: Is this an issue if both email and password change at the same time?
  $response.sendRedirect($xwiki.getURL("Main.WebHome"))
#end
#if($xwiki.hasAdminRights())
  ## Is an admin, so don't bother with verification
  #if("$!request.user" != "")
    #set($userarg = "user=${request.user}")
  #else
    #set($userarg = "")
  #end
  $response.sendRedirect($xwiki.getURL("MySankore.Profile", "view", "$userarg"))
#else
  ## Logout the user and redirect to Email Verification page
  #set($username = $context.user.replace("XWiki.", ""))
  #set($userDoc = $xwiki.getDocument("XWiki.${username}"))
  #set($userObj = $!userDoc.getObject("XWiki.XWikiUsers"))
  #set($junk = $userObj.set("active", 0))
  #set($junk = $userObj.set("email_undeliverable", 1))
  #set($junk = $userDoc.saveWithProgrammingRights())
  #set($session = $request.getSession(true))
  #set($xredirect = $xwiki.getURL("Registration.EmailVerification", "view", "username=${username}"))
  $response.sendRedirect($xwiki.getURL("XWiki.XWikiLogout", "logout", "xredirect=${xredirect}"))
#end
#end

#**
  * Displays the profile of the user
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_viewprofile $userdoc $userobj)
<div class="userInfo">
<h2>$msg.get("profile.section.userInfo")</h2>
<ul>
<li id="first_name">  
  <span class="label"><strong>$msg.get("profile.field.display.firstName")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("first_name", "view", $userobj))</span>
</li>
<li id="last_name">
  <span class="label"><strong>$msg.get("profile.field.display.lastName")</strong></span>
  <span class="value">#mycurriki_dashifempty($userdoc.display("last_name", "view", $userobj))</span>
</li>
<li id="city">  
  <span class="label"><strong>$msg.get("profile.field.city")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("city", "view", $userobj))</span>
</li>
##<li id="state">
  ##<span class="label"><strong>$msg.get("profile.field.state")</strong></span>    
  ##<span class="value">#mycurriki_dashifempty($userdoc.display("state", "view", $userobj))</span>
##</li>
<li id="country">
  <span class="label"><strong>$msg.get("profile.field.country")</strong></span>    
  <span class="value">  
  #mycurriki_dashifempty($userdoc.display("country", "view", $userobj))
  </span>
</li>
<li id="email">
  <span class="label"><strong>$msg.get("profile.field.email")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("email", "view", $userobj))</span>
</li>
<li id="member_type">  
  <span class="label"><strong>$msg.get("profile.field.memberType")</strong></span>
  <span class="value">#mycurriki_dashifempty($userdoc.display("member_type", "view", $userobj))</span>
</li>
<li id="affiliation">
  <span class="label"><strong>$msg.get("profile.field.affiliation")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("affiliation", "view", $userobj))</span>
</li>
<li id="bio">  
  <span class="label"><strong>$msg.get("profile.field.bio")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("comment", "view", $userobj))</span>
</li>
</ul>
</div>
#if($hasAdmin || ("$!request.user" != "" && "$context.user" == "$request.user") || "$!request.user" == "")
<div class="userPrivacy">
<h2>$msg.get("profile.section.userPrivacy")</h2>
<ul>
<li id="show_contact">
  <span class="label"><strong>$msg.get("profile.field.showContact")</strong></span>
  <span class="value">#mycurriki_dashifempty($userdoc.display("show_contact", "view", $userobj))</span>
</li>
<li id="opt_out">
  <span class="label"><strong>$msg.get("profile.field.opt_out")</strong></span>    
  <span class="value">#mycurriki_dashifempty($userdoc.display("opt_out", "view", $userobj))</span>
</li>
</ul>
</div>
#end
#end ## end macro


#**
  * Displays the profile of the user with his photo
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_viewprofiletable $userdoc $userobj)
  ## This is the main display
  #set($class = $userobj.xWikiClass)
  <div class="view-profile">
  <table border="0" cellspacing="0" cellpadding="3">
  <tbody>
  <tr>
    <td valign="top">
    #mycurriki_viewphoto($userdoc)
    #if($userdoc.attachmentList.size()==0 && "$!context.action"=="view" && "$!request.ajax"=="")
      #if(($userdoc.fullName==$context.user)||$xwiki.hasAdminRights())
        #set($redirect = $xwiki.requestURL)
        <div id="attachdiv" class="hidden">
        <form id="attach" action="$userdoc.getURL('upload')" enctype="multipart/form-data" method="post" name="profilImageAttach">          
          <input type="hidden" name="xredirect" value="$userdoc.getURL()"/>
          <input id="xwikiuploadname" type="hidden" name="filename" value="" size="20"/>
          <fieldset style="width:90%" class="expanded" id="attachform">
            <div><label id="xwikiuploadfilelabel" for="xwikiuploadfile">$msg.get("profile.chooseAPhoto")</label></div>
            <div><input id="xwikiuploadfile" type="file" name="filepath" value="" size="20"/></div>
            <div>
            <input type="submit" class="button button-confirm" value="$msg.get("attachthisfile")" onclick="if (!Curriki.mycurriki.validateImgExtension('xwikiuploadfile')) return false; return updateAttachName(document.forms.profilImageAttach, '$msg.get("doyouwanttoreplace")')" />
            </div>
          </fieldset>
        </form>
        </div>
      #end
    #end
    </td>
    <td width="100%">
    #mycurriki_viewprofile($userdoc $userobj)
    </td>
  </tr>
  </tbody>
  </table>
</div>
#end ## end macro


#**
  * Displays the profile of the user with a title bar
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_viewprofilebox $userdoc $userobj)
##curriki_titlebar($msg.get("mycurriki.profile.titlebar") "" "" "blue")
#if($isGuest)
  #set($logredir = $doc.getURL("view"))
  #set($loginurl = $xwiki.getURL("XWiki.XWikiLogin", "login", "xredirect=$logredir"))
  #if("$!request.user" == "")
    $response.sendRedirect($loginurl)
  #else
    $msg.get("profile.accessDenied", [$loginurl])
  #end
#else ## if XWiki.XWikiGuest
  #set($showcontact = $userobj.getProperty("show_contact").getValue())
  #if(($showcontact=="0")&&($context.user!=$userdoc.fullName)&&(!$xwiki.hasAdminRights()))
    $msg.get("profile.userNotVisible")
  #else ## if showcontact == No
    #mycurriki_viewprofiletable($userdoc $userobj)
  #end ## if showcontact == No
#end ## if XWikiGuest
#end ## end macro

##
## My Curriki Favorites
##
##


#**
  * Displays the favorites header
  *
  * @param $allcols True if we show the action column of the favorites
  *#
#macro(mycurriki_favoritesheader $allcols)
<tr>
  <th class="table-header table-col-title">$msg.get('mycurriki.favorites.table.title')</th>
  <th class="table-header table-col-contributor">$msg.get('mycurriki.favorites.table.contributor')</th>
  <th class="table-header table-col-ict">$msg.get('mycurriki.favorites.table.ict')</th>
  <th class="table-header table-col-filetype">$msg.get('mycurriki.favorites.table.filetype')</th>
  #if($allcols)
    <th class="table-header table-header-fixed table-col-action">$msg.get('mycurriki.favorites.table.action')</th>
  #end ## if allcols
</tr>
#end ## end macro


#**
  * Displays the a favorite item
  *
  * @param $asset Asset to display
  * @param $allcols True if we show the action column of the favorites
  *#
#macro(mycurriki_favoritesasset $asset $allcols)
#if(!$g_rowCount)
  #set($g_rowCount = 0)
#end
#set($g_rowCount = $g_rowCount + 1)
<tr class="table-row#if(($g_rowCount % 2) == 0) table-odds#end">
  <td class="table-col-title">#mycurriki_assettitlewithmodesc($asset)</td>
  <td class="table-col-contributor">#mycurriki_contributor($asset)</td>
  <td class="table-col-ict">#mycurriki_ict($asset false)</td>
  <td class="table-col-filetype">#mycurriki_filetype($asset)</td>
  #if($allcols)
    <td class="table-col-action">
      <div class="button-links">
        #set($g_actionFirst = true)
        #mycurriki_action_add($asset 'H')
        #mycurriki_action_remove($asset)
      </div>
    </td>
  #end ## if allcols
</tr>
#end ##end macro

#**
  * Displays the pagination footer for the favorites section
  *
  * @param $startIndex start index of the pagination
  * @param $nbToDisplay number of elements shown in a page
  * @param $assetList asset list that is displayed
  *#
#macro(mycurriki_favoritespagination $startIndex $nbToDisplay $assetList) ##{
  #curriki_paginator($msg.get("mycurriki.tab.favorites.label") $startIndex $nbToDisplay $assetList.size())
#end ## } end macro mycurriki_favoritespagination


#**
  * Displays the favorites button of the user
  *
  * @param $userobj Object of the user
  *#
#macro(mycurriki_favoritesbutton $userobj)
  #if($context.user==$userdoc.fullName)
    #set($shortname = $userdoc.fullName)
    #set($breadcrumb="MySankore.WebHome")
    #if($shortname.startsWith("XWiki.")) ## {
      #set($shortname = $shortname.substring(6))
    #end ## }
    #set($favPage = "Coll_${shortname}.Favorites")
    #if($xwiki.exists($favPage)) ## {
      #set($favDoc = $xwiki.getDocument("Coll_${shortname}.Favorites"))
      #set($assetList = $favDoc.getObjects('CurrikiCode.SubAssetClass'))
      #if($assetList.size() > 0) ## {
        #if("$!breadcrumb" == "") ## {
          #set($breadcrumb=$userdoc.fullName)
        #end ## }
        <a class="button button-confirm" href="$xwiki.getURL("${favPage}", "view", "bc=${breadcrumb}")" title="$msg.get("mycurriki.favorites.viewButton")">$msg.get("mycurriki.favorites.viewButton")</a></span>
      #end ## }
    #end ## }
  #end ## }
#end

#**
  * Displays the favorites box
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_favoritesbox $userdoc $userobj) ##{
  #set($allcols = false)
  #if($context.user=="XWiki.XWikiGuest") ## {
    ## Settings for guests here
  #end ## }
  #if($hasGlobalAdmin) ## {
    ## Settings for admins here
    #set($allcols = true)
  #end ## }
  #if($context.user==$userdoc.fullName) ## {
    ## Settings for owner here
    #set($allcols = true)
  #end ## }
  #set($shortname = $userdoc.fullName)
  #if($shortname.startsWith("XWiki.")) ## {
    #set($shortname = $shortname.substring(6))
  #end ## }
  ## Do query for favorites
  #set($favDoc = $xwiki.getDocument("Coll_${shortname}.Favorites"))
  #set($assetList = $favDoc.getObjects('CurrikiCode.SubAssetClass'))
  #set($nbToDisplay = 20)
  #set($startIndex = 0)
  #set($Integer = 0)
  #if($request.startIndex) ## {
    #set($startIndex = $Integer.parseInt($request.getParameter("startIndex")))
  #end ## }
  #if($startIndex > ($assetList.size() - 1)) ## {
    #set($startIndex = $assetList.size() - 1)
  #end ## }
  #set($endIndex = $startIndex - 1 + $nbToDisplay)
  #if($endIndex > ($assetList.size() - 1)) ## {
    #set($endIndex = $assetList.size() - 1)
  #end ## }
  ## Display favorites in table using pagination
  <table id="mycurriki-favorites-table" class="table table-favorites">
    #mycurriki_favoritesheader($allcols)
    ## row per item -- number of rows configurable
    #set($descnb = 0)
    #set($showcount = 0)
    #foreach($assetPointer in $assetList) ## {
      #set($assetPage = $assetPointer.get('assetpage'))
      #if($xwiki.hasAccessLevel("view", $context.user, $assetPage)) ## {
        #set($asset = $xwiki.getDocument($assetPage))
        #set($type = $!asset.getValue("type", $asset.getObject("CurrikiCode.TextAssetClass")))
        #if("$type"!="2") ## {
          #set($showcount = 1 + $showcount)
          #if(($showcount > $startIndex) && ($showcount < ($endIndex + 2))) ## {
            #mycurriki_favoritesasset($asset $allcols)
          #end ## showcount > startIndex && showcount < endIndex ## }
        #end  ## type != 2 ## }
      #end  ## if has view access ## }
    #end ## foreach assetPage in list ## }
    #if($showcount == 0) ## {
      <tr><td colspan="6">$msg.get("mycurriki.favorites.noresults")</td></tr>
    #end ## }
  </table>
  ## Pagination here
  #mycurriki_favoritespagination( $startIndex $nbToDisplay $assetList )
#end ##} end macro mycurrikifavoritesbox


#**
  * MySankore Favorites
  * Remove a favorite
  * @param $requestdocName Doc name to remove from favorite
  *#
#macro(mycurriki_removefavorite)
#if($request.docName) ## {
 #if("1" == $request.confirm) ## {
  #set($shortname = $context.user)
  #if($shortname.startsWith("XWiki.")) ## {
   #set($shortname = $shortname.substring(6))
  #end ## }
  #set($favPage = "Coll_${shortname}.Favorites")
  #set($done = false)
  #if($xwiki.exists($favPage)) ## {
   #set($favDoc = $xwiki.getDocument("Coll_${shortname}.Favorites"))
   #set($assetList = $favDoc.getObjects('CurrikiCode.SubAssetClass'))
   #foreach($assetPointer in $assetList) ## {
    #if($request.docName == $assetPointer.get('assetpage')) ## {
     #set($junk = $favDoc.removeObject($assetPointer))
     #set($junk = $favDoc.save($msg.get("mycurriki.favorites.removed.comment", [$request.docName])))
     #set($done = true)
    #end ## if }
   #end ## foreach }
  #end ## if }
 #end ## if confirm }
 #if ($request.sourceDoc) ## {
 $response.sendRedirect($request.sourceDoc)
 #else ## } {
  #if($message) ## {
<div id="xwikimessage">
$message
</div>
  #end ## }
<div id="xwikicontent">
<br />
$msg.get("deleted")
<br />
<br />
<br />
</div>
 #end ## }
#else ## } {
 #if ($request.sourceDoc) ## {
 $response.sendRedirect($request.sourceDoc)
 #else ## } {
 $response.sendRedirect($xwiki.getURL("MySankore.Favorites"))
 #end ## }
#end ## }
#end ## }

##
## My Curriki Contributions
##
##


#**
  * Displays the contributions header
  *
  * @param $sortBy Sorting column
  * @param $sortDir Sorting direction
  * $param $headersArgs Arguments added to the url
  * @param $allcols true if the actions columns are added
  *#
#macro(mycurriki_contributionsheader $sortBy $sortDir $headerArgs $allcols) ##{
  <tr>
      #if($sortBy=="title" && $sortDir == "asc") ## {
        #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}sortBy=title&sortDir=desc"))
      #else ## } {
        #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}sortBy=title"))
      #end ## }
      <th class="table-header#if($sortBy=="title") table-header-sorted#end table-col-title"><a href="$url">$msg.get('mycurriki.contributions.table.title')</a></th>
      <th class="table-header table-header-fixed table-col-ict">$msg.get('mycurriki.contributions.table.ict')</th>
      #if($sortBy=="date" && $sortDir == "desc") ## {
        #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}sortDir=asc"))
      #else ## } {
        #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}"))
      #end ## }
      <th class="table-header#if($sortBy=="date") table-header-sorted#end table-col-lastupdated"><a href="$url">$msg.get('mycurriki.contributions.table.lastupdated')</a></th>
      #if($allcols)
        #if($sortBy=="access" && $sortDir == "asc") ## {
          #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}sortBy=access&sortDir=desc"))
        #else ## } {
          #set($url = $xwiki.getURL($doc.fullName, "view", "${headerArgs}sortBy=access"))
        #end ## }
        <th class="table-header#if($sortBy=="access") table-header-sorted#end table-col-access"><a href="$url">$msg.get('mycurriki.contributions.table.access')</a></th>
      #end ## if allcols
      <th class="table-header table-header-fixed table-col-filetype">$msg.get('mycurriki.contributions.table.filetype')</th>
      #if($allcols)
        <th class="table-header table-header-fixed table-col-action">$msg.get('mycurriki.contributions.table.action')</th>
      #end ## if allcols
    </tr>
#end ##} end macro mycurrikicontributionsheader



#**
  * Determine if the user is in the group owning the resource
  *
  * @param $asset Asset
  * @returns $ret_assetGroupAdmin
  *#
#macro(assets_userIsGroupAdmin $asset) ##{
#set($sm = $xwiki.csm)
#set($ret_assetGroupAdmin = false)
#if($asset.creator == $context.user || $sm.isAdmin($asset.web.replaceFirst('Coll_', ''), $context.user) || $hasGlobalAdmin) ##{
  #set($ret_assetGroupAdmin = true)
#end ##}
#end ##}

#**
  * Determine if the user is in the group owning the resource
  *
  * @param $asset Asset
  * @returns $ret_assetGroupMember
  *#
#macro(assets_userInGroup $asset) ##{
#set($sm = $xwiki.csm)
#set($ret_userInAssetGroup = false)
#if($asset.creator == $context.user || $sm.isMember($asset.web.replaceFirst('Coll_', ''), $context.user) || $hasGlobalAdmin) ##{
  #set($ret_assetGroupMember = true)
#end ##}
#end ##}

#**
  * Displays the "Add" action if available
  *
  * @param $asset Asset
  * @param $addpath Add path to follow
  * @param $g_userHasCollections Impl param True if the user has collections
  *#
#macro(mycurriki_action_add $asset $addpath)
  ## Not available on "Favorites" page except for owner/admin
  #checkForCollections()
  #if($g_userHasCollections)
    #set($escapedFullName = $escapetool.xml($escapetool.javascript($asset.fullName)))
    #asset_findtitle($asset)
    #set($escapedTitle = $escapetool.xml($escapetool.javascript($currikiTitle)))
    #if($asset.creator == $context.user || $hasGlobalAdmin || $doc.name != 'Favorites' || ($g_userdoc.fullName == $context.user && $doc.name == 'Favorites'))
    #verbatim_start
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="#" onclick="Curriki.module.addpath.startPath('${addpath}', {assetName:'$escapedFullName', assetTitle:'$escapedTitle'}); return false;" ext:qtip="$escapetool.xml($msg.get('mycurriki.link.add.tooltip'))">$msg.get('mycurriki.link.add')</a>
    #verbatim_end
    #end##}
  #end##}
#end ##}

#**
  * Displays the "Remove" action if available
  *
  * @param $asset Asset
  *#
#macro(mycurriki_action_remove $asset) ##{
  ## ONLY on Favorites page (removes from Favorites list)
  ## ONLY for owner + admin
  #if($doc.name == 'Favorites' && ($g_userdoc.fullName == $context.user || $hasGlobalAdmin)) ##{
    #set($removeMsg = $msg.get('mycurriki.favorites.table.action.remove.confirm'))
    #set($deleteUrl = $xwiki.getURL("MySankore.RemoveFavorite", "view", "confirm=1&docName=${asset.fullName}&sourceDoc=$doc.getURL('view')"))
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" onclick="return confirm('$removeMsg')" href="$deleteUrl" ext:qtip="$msg.get('mycurriki.favorites.table.action.remove_tooltip')">$msg.get("mycurriki.favorites.table.action.remove")</a>
  #end ##}
#end ##}

#**
  * Displays the "Delete" action if available
  *
  * @param $asset Asset
  *#
#macro(mycurriki_action_delete $asset) ##{
  ## ONLY for owner + admin
  #assets_userIsGroupAdmin($asset)
  #if($ret_assetGroupAdmin || $hasGlobalAdmin) ##{
    #set($deleteMsg = $msg.get('mycurriki.link.delete.confirm'))
    #set($deleteUrl = $xwiki.getURL("XWiki.DeleteDocument", "view", "confirm=1&docName=${asset.fullName}&sourceDoc=$doc.getURL('view')"))
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" onclick="return confirm('$deleteMsg')" href="$deleteUrl" ext:qtip="$msg.get('mycurriki.link.delete.tooltip')">$msg.get("mycurriki.link.delete")</a>
  #end ##}
#end ##}

#**
  * Displays the "Copy" action if available
  *
  * @param $asset Asset
  * @param $addpath Add path to follow
  * @param $g_userHasCollections Impl param True if the user has collections
  *#
#macro(mycurriki_action_copy $asset $addpath) ##{
  ## Not available on "Favorites" page
  ## File Resources only (not Collections/Folders)
  #checkForCollections()
  #if($asset.getCategory() != 'collection') ##{
    #set($escapedFullName = $escapetool.xml($escapetool.javascript($asset.fullName)))
    #if($doc.name != 'Favorites' && ($asset.creator == $context.user || $hasGlobalAdmin))##{
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="#" onclick="Curriki.module.addpath.startPath('${addpath}', {copyOf:'${escapedFullName}'}); return false;" ext:qtip="$msg.get('mycurriki.link.copy.tooltip')">$msg.get('mycurriki.link.copy')</a>
    #end##}
  #end##}
#end ##}

#**
  * Displays the "Edit Content" action if available
  *
  * @param $asset Asset
  *#
#macro(mycurriki_action_editcontent $asset) ##{
  ## ONLY for owner + admin
  ## ONLY for File Resources (not Collections)
  #assets_userIsGroupAdmin($asset)
  #if($asset.getCategory() != 'collection' && ($ret_assetGroupAdmin || $hasGlobalAdmin)) ##{
    #set($editUrl = $asset.getURL('view', 'viewer=assetedit'))
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="$editUrl" ext:qtip="$msg.get('mycurriki.link.editcontent.tooltip')">$msg.get("mycurriki.link.editcontent")</a>
  #end ##}
#end ##}

#**
  * Displays the "Edit Info" action if available
  *
  * @param $asset Asset
  *#
#macro(mycurriki_action_editinfo $asset)
  ## ONLY for owner + admin
  #assets_userIsGroupAdmin($asset)
  #if($ret_assetGroupAdmin || $hasGlobalAdmin)    
    #set($editUrl = "javascript:Curriki.module.addpath.startPath('Metadata', {assetName:'$asset.fullName'});")
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="$editUrl" ext:qtip="$msg.get('mycurriki.link.editinfo.tooltip')">$msg.get("mycurriki.link.editinfo")</a>
  #end
#end

#**
  * Displays the "Build Up" action if available
  *
  * @param $asset Asset
  * @param $addpath Add path to follow
  *#
#macro(mycurriki_action_buildup $asset $addpath) ##{
  ## Not available on "Favorites" page
  ## ONLY for owner + admin
  ## ONLY Collections
  #if($asset.getCategory() == 'collection') ##{
    #set($escapedFullName = $escapetool.xml($escapetool.javascript($asset.fullName)))
    #asset_findtitle($asset)
    #set($escapedTitle = $escapetool.xml($escapetool.javascript($currikiTitle)))
    #assets_userInGroup($asset)
    #if($doc.name != 'Favorites' && ($ret_assetGroupMember || $hasGlobalAdmin))##{
    <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="#" onclick="Curriki.module.addpath.startPath('${addpath}', {parentAsset:'$escapedFullName', parentTitle:'$escapedTitle'}); return false;" ext:qtip="$msg.get('mycurriki.link.buildup.tooltip')">$msg.get('mycurriki.link.buildup')</a>
    #end##}
  #end##}
#end ##}

#**
  * Displays the "Organize" action if available
  *
  * @param $asset Asset
  *#
#macro(mycurriki_action_organize $asset) ##{
  ## Not available on "Favorites" page
  ## ONLY for owner + admin
  ## ONLY Collections
  #if($asset.getCategory() == 'collection') ##{
    #set($escapedFullName = $escapetool.xml($escapetool.javascript($asset.fullName)))
    #asset_findtitle($asset)
    #set($escapedTitle = $escapetool.xml($escapetool.javascript($currikiTitle)))
    #set($escapedCreatorName = $escapetool.xml($escapetool.javascript($xwiki.getUserName($asset.creator, false))))
    #if($doc.name != 'Favorites' && ($asset.creator == $context.user || $hasGlobalAdmin))##{
      #set($cnt = $asset.as($xwiki.null).getSubassetList().size())
      #if($cnt > 0) ##{
      <a class="button-link#if($g_actionFirst) first-item#set($g_actionFirst = false)#end" href="#" onclick="Curriki.module.organize.start({assetPage:'$escapedFullName', title:'$escapedTitle', creator:'${asset.creator}', creatorName:'${escapedCreatorName}'}); return false;" ext:qtip="$msg.get('mycurriki.link.organize.tooltip')">$msg.get('mycurriki.link.organize')</a>
      #end##}
    #end##}
  #end##}
#end ##}



#**
  * Displays a contributions asset
  *
  * @param $asset Asset to display
  * @param $allcols true if the actions columns are added
  *#
#macro(mycurriki_contributionsasset $asset $allcols)
  #if(!$g_rowCount) ## {
    #set($g_rowCount = 0)
  #end ## }
  #set($g_rowCount = $g_rowCount + 1)
  <tr class="table-row#if(($g_rowCount % 2) == 0) table-odds#end">
    <td class="table-col-title">#mycurriki_assettitlewithmodesc($asset)</td>
    <td class="table-col-ict">#mycurriki_ict($asset)</td>
    <td class="table-col-updated">#mycurriki_lastupdate($asset)</td>
    #if($allcols)
      <td class="table-col-access">#mycurriki_access($asset)</td>
    #end ## if allcols
    <td class="table-col-filetype">#mycurriki_filetype($asset)</td>
    #if($allcols)
      <td class="table-col-action">
        <div class="button-links">
          #set($g_actionFirst = true)
          #mycurriki_action_add($asset 'J')
          #mycurriki_action_copy($asset 'Copy')
          #mycurriki_action_buildup($asset 'L')
          #mycurriki_action_editcontent($asset)
          #mycurriki_action_editinfo($asset)
          #mycurriki_action_organize($asset)
          #mycurriki_action_delete($asset)
        </div>
      </td>
    #end ## if allcols
  </tr>
#end


#**
  * Displays the pagination footer for the contributions section
  *
  * @param $startIndex start index of the pagination
  * @param $nbToDisplay number of elements shown in a page
  * @param $showcount If we should show a count of the number of contributions
  * @param $sortArgs The sort arguments for the url
  *#
#macro(mycurriki_contributionspagination $startIndex $nbToDisplay $showcount $sortArgs) ##{
  #curriki_paginatorargs($msg.get("mycurriki.tab.contributions.label") $startIndex $nbToDisplay $showcount $sortArgs)
#end ##} end macro


#**
  * Displays the contributions button of the user
  *
  * @param $userobj Object of the user
  *#
#macro(mycurriki_contributionsbutton $userdoc $userobj )
  #if($context.action == "view" && ($context.user==$userdoc.fullName || $hasGlobalAdmin))##{
    #verbatim_start
    <a class="button button-confirm" onclick="Curriki.module.addpath.startPath('I', {});" title="$msg.get('mycurriki.contributions.addButton_tooltip')">$msg.get('mycurriki.contributions.addButton')</a>
    #verbatim_end
  #end ##}
#end ##} end macro


#**
  * Displays the contributions box
  *
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_contributionsbox $userdoc $userobj)
  #set($headerArgs="user=${userdoc.fullName}&")
  #set($allcols = false)
  #if($context.user=="XWiki.XWikiGuest")
    ## Settings for guests here
  #end
  #if($hasGlobalAdmin)
    ## Settings for admins here
    #set($allcols = true)
  #end
  #if($context.user==$userdoc.fullName)
  ## Settings for owner here
    #set($allcols = true)
    #set($headerArgs="")
  #end
  #set($shortname = $userdoc.fullName)
  #if($shortname.startsWith("XWiki."))
    #set($shortname = $shortname.substring(6))
  #end
  #set($descnb = 0)
  ## Do query for contributions
  #if("$!request.sortBy"=="")
    #set($sortBy = "date")
    #set($sortDir = 'desc')
  #elseif($request.sortBy=="date")
    #set($sortBy = "date")
    #set($sortDir = 'desc')
  #elseif($request.sortBy=="title")
    #set($sortBy = "title")
    #set($sortDir = 'asc')
  #elseif($request.sortBy=="access" && $allcols)
    #set($sortBy = "access")
    #set($sortDir = 'asc')
  #else
    #set($sortBy = "date")
    #set($sortDir = 'desc')
  #end  
  #if("$!request.sortDir"=="")
  #elseif($request.sortDir=="asc")
    #set($sortDir = 'asc')
  #elseif($request.sortDir=="desc")
    #set($sortDir = 'desc')
  #end  
  #set($sortArgs = "")
  #if($sortBy == "date")
    #if($sortDir == "asc")
      #set($sortArgs = "sortDir=asc")
    #end
  #elseif ($sortBy == "title")
    #set($sortArgs = "sortBy=title")
    #if($sortDir == "desc")
      #set($sortArgs = "${sortArgs}&sortDir=desc")
    #end
  #elseif ($sortBy == "access")
    #set($sortArgs = "sortBy=access")
    #if($sortDir == "desc")
      #set($sortArgs = "${sortArgs}&sortDir=desc")
    #end
  #end
  ##
  ## Order by reverse last updated
  #set($baseWhere = "where doc.fullName=obj.name AND obj.className='CurrikiCode.AssetClass' AND doc.creator='${userdoc.fullName}' AND doc.web != 'AssetTemp' AND doc.name != 'Favorites' AND doc.name != 'WebHome' AND doc.fullName NOT IN (SELECT cbobj.name FROM BaseObject as cbobj, IntegerProperty as cbprop WHERE cbobj.className='CurrikiCode.TextAssetClass' AND cbobj.name = doc.fullName AND cbobj.id=cbprop.id.id AND cbprop.id.name='type' AND cbprop.value=2)")
  #set($globalView = " 0=1 ")
  #if($!hasGlobalAdmin)
    #set($globalView = " 1=1 ")
  #end
  #set($rightsWhere = " AND (${globalView} OR '${userdoc.fullName}'='${context.user}' OR doc.fullName NOT IN (SELECT robj.name FROM BaseObject as robj, StringProperty as rprop WHERE robj.className='CurrikiCode.AssetClass' AND robj.name = doc.fullName AND robj.id=rprop.id.id AND rprop.id.name='rights' AND rprop.value = 'private')) ")
  #set($baseWhere = "${baseWhere} ${rightsWhere}")
  #if($sortBy=="title")
    #set($sql = ", BaseObject as obj, StringProperty as category ${baseWhere} and category.id.id=obj.id and category.name='category' and category.value!='collection' order by doc.title $sortDir")
  #elseif($sortBy=="access") ## Default sort by rights
    #set($sql = ", BaseObject as obj, StringProperty as category, StringProperty as rights ${baseWhere} and category.id.id=obj.id and category.name='category' and category.value!='collection' and obj.id=rights.id.id and rights.id.name='rights' order by rights.value $sortDir, doc.title asc")
  #else ## Default sort by date
    #set($sql = ", BaseObject as obj, StringProperty as category ${baseWhere} and category.id.id=obj.id and category.name='category' and category.value!='collection' order by doc.date $sortDir")
  #end
  ## Order by property ascending
  ## How can we sort by
  ## filetype (determined in a macro)
  ## instructional_component (if not exists how do we act as blank)
  ##doesnt work #set($sql = ", BaseObject as obj left outer join StringProperty as prop1 on obj.id=prop1.id.id and prop1.id.name='instructional_component' where doc.fullName=obj.name and obj.className='CurrikiCode.AssetClass' and doc.creator='${userdoc.fullName}' and doc.web != 'AssetTemp' and doc.name != 'Favorites' order by prop1.value $sortDir")
  ##
  ##
  #set($assetList = $xwiki.searchDocuments($sql))
  #set($nbToDisplay = 20)
  #set($startIndex = 0)
  #set($Integer = 0)
  #if($request.startIndex)
    #set($startIndex = $Integer.parseInt($request.getParameter("startIndex")))
  #end
  #if($startIndex > ($assetList.size() - 1))
    #set($startIndex = $assetList.size() - 1)
  #end
  #set($endIndex = $startIndex - 1 + $nbToDisplay)
  #if($endIndex > ($assetList.size() - 1))
    #set($endIndex = $assetList.size() - 1)
  #end
  ## Display contributions in table using pagination
  <table id="mycurriki-contributions-table" class="table table-contributions">
    #mycurriki_contributionsheader($sortBy $sortDir $headerArgs $allcols)
    ## row per item -- number of rows configurable
    #set($showcount = 0)
    #foreach($assetPage in $assetList)
      #set($showcount = 1 + $showcount)
      #if(($showcount > $startIndex) && ($showcount < ($endIndex + 2)))
        #set($asset = $xwiki.getDocument($assetPage))
        #mycurriki_contributionsasset($asset $allcols)
      #end ## showcount > startIndex && showcount < endIndex
    #end ## foreach assetPage in list
    #if($showcount == 0)
      <tr><td colspan="6">$msg.get("mycurriki.contributions.noresults")</td></tr>
    #end
  </table>
  ## Pagination here
  #mycurriki_contributionspagination($startIndex $nbToDisplay $showcount $sortArgs)  
#end ##} end macro


##
##
##
## Collections Macros
##
##
#**
  *  My Curriki Collection Actions
  *
  *  @param $asset Asset to display actions for
  *#
#macro(mycurriki_collectionactions $asset)
#set($g_actionFirst = true)
#mycurriki_action_add($asset 'J')
#mycurriki_action_buildup($asset 'L')
#mycurriki_action_editinfo($asset)
#mycurriki_action_organize($asset)
#mycurriki_action_delete($asset)
#end
##
##
#**
  *  My Curriki Collection Display
  *
  *  @param $asset Asset to display
  *#
#macro(mycurriki_collection $asset)
#if(!$g_rowCount)
#set($g_rowCount = 0)
#end
#set($g_rowCount = $g_rowCount + 1)
<div class="frame-inset#if(($g_rowCount % 2) == 0) table-odds#end">
<div>
<div class="button-links">
#mycurriki_collectionactions($asset)
</div>
<div class="frame-inset-ict">
#mycurriki_ict($asset)
</div>
<div class="frame-inset-title">
#mycurriki_assettitlewithmodesc($asset)
</div>
</div>
<div class="frame-inset-description mycurriki-collections-row-description">
#mycurriki_collectiondescription($asset)
</div>
</div>
#end

#**
  * MySankore Collections Page Content Call Back function
  * @param $userdoc Document of the user
  * @param $userobj Object of the user
  *#
#macro(mycurriki_collections $userdoc $userobj)
#if($context.user=="XWiki.XWikiGuest")
## Settings for guests here
#end
#if($context.user==$userdoc.fullName)
## Settings for owner here
#end
#set($shortname = $userdoc.fullName)
#if($shortname.startsWith("XWiki."))
  #set($shortname = $shortname.substring(6))
#end
#if(($userdoc.fullName == $context.user || $hasGlobalAdmin))
  #set($cnt = $xwiki.search("select count(*) from XWikiDocument as doc, BaseObject as obj, StringProperty as props where obj.id=props.id.id and doc.fullName=obj.name and obj.className='CurrikiCode.CompositeAssetClass' and doc.web='Coll_${shortname}' and doc.name != 'WebHome' and doc.name != 'Favorites' and props.id.name='type' and props.value='collection'").get(0))
  #set($multiple = ($cnt > 1))
  #if($multiple)
    #set($reorder = $xwiki.search("select count(*) from XWikiDocument as doc, BaseObject as obj, IntegerProperty as props where obj.id=props.id.id and doc.fullName=obj.name and obj.className='CurrikiCode.CollectionReorderedClass' and doc.fullName='Coll_${shortname}.WebHome' and props.id.name='reordered' and props.value=1").get(0))
    #set($reordered = ($reorder > 0))
#verbatim_start
<script type="text/javascript">
/* <![CDATA[ */
Curriki.data.reorder = {
  place:'users'
  ,which:'${userdoc.fullName}'
  ,reordered:${reordered}
};
/* ]]> */
</script>
<script type="text/javascript" src="/xwiki/js/curriki-module-reorder.js"></script>
#verbatim_end
  #end
#end
## Get collections
#set($assetList = $xwiki.curriki.fetchCollectionsList($shortname))
#set($nbToDisplay = 20)
#set($startIndex = 0)
#set($Integer = 0)
#if($request.startIndex)
  #set($startIndex = $Integer.parseInt($request.getParameter("startIndex")))
#end
#if($startIndex > ($assetList.size() - 1))
  #set($startIndex = $assetList.size() - 1)
#end
#set($endIndex = $startIndex - 1 + $nbToDisplay)
#if($endIndex > ($assetList.size() - 1))
  #set($endIndex = $assetList.size() - 1)
#end
##
#verbatim_start
<script type="text/javascript">
var $hidden = false;
function toggle_desc(){
  var $action;
  var $titl;
  if ($hidden){
    $hidden = false;
    $action = 'show';
    $titl = "$msg.get('mycurriki.collections.titlebarbutton')";
  } else {
    $hidden = true;
    $action = 'hide';
    $titl = "$msg.get('mycurriki.collections.titlebarbuttonalt')";
  }
  $$('.mycurriki-collections-row-description').invoke($action);
  $('hider-link').title=$titl;
  $('hider-link').innerHTML=$titl+"  &raquo;";
  return false;
}
</script>
#verbatim_end
## row per item -- number of rows configurable
#set($showcount = 0)
#foreach($assetPage in $assetList)
  #if($xwiki.hasAccessLevel("view", $context.user, $assetPage))
    #set($showcount = 1 + $showcount)
    #if(($showcount > $startIndex) && ($showcount < ($endIndex + 2)))
      #set($asset = $xwiki.getDocument($assetPage))
      #mycurriki_collection($asset)
    #end ## showcount > startIndex && showcount < endIndex
  #end  ## if has view access
#end ## foreach assetPage in list
#if($showcount == 0)
<div class="centertext">$msg.get("mycurriki.collections.noresults")</div>
#end ## showcount
#curriki_paginator($msg.get("mycurriki.tab.collections.label") $startIndex $nbToDisplay $assetList.size())
#end ## content macro

#**
  * MySankore Collections Page Button Call Back function
  * @param $userobj Object of the user
  *#
#macro(mycurriki_collections_buttons $userobj)
#if($context.action == "view" && ($context.user==$userdoc.fullName || $hasGlobalAdmin))
#verbatim_start
<a class="button button-confirm" onclick="Curriki.module.reorder.start(); return false;" alt="$msg.get('mycurriki.collections.reorder')" title="$msg.get('mycurriki.collections.reorder_tooltip')">$msg.get("mycurriki.collections.reorder")</a>
<a class="button button-confirm" onclick="Curriki.module.addpath.startPath('K', {});" alt="$msg.get('mycurriki.collections.add')" title="$msg.get('mycurriki.collections.add_tooltip')">$msg.get("mycurriki.collections.add")</a>
#verbatim_end
#end
#end ## buttonmacro

#macro(mycurriki_groups_join_button $userobj)
  #if($context.action == "view" && ($context.user==$userdoc.fullName || $hasGlobalAdmin))
    #verbatim_start
      <a class="button button-confirm" href="$xwiki.getDocument('Search.Groups').getURL()" alt="$msg.get('mycurriki.groups.rejoindre')" title="$msg.get('mycurriki.groups.rejoindre')">$msg.get("mycurriki.groups.rejoindre")</a>
    #verbatim_end
  #end
#end

## End of MySankore Macros 
